name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Login to Yandex Container Registry
      uses: docker/login-action@v2
      with:
        registry: cr.yandex
        username: json_key
        password: ${{ secrets.YC_SA_KEY_JSON }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          cr.yandex/crpvrfum4pqm6pp2sv53/risk-reporter-bot:${{ github.sha }}
          cr.yandex/crpvrfum4pqm6pp2sv53/risk-reporter-bot:latest

    - name: Deploy to Yandex Cloud Container
      uses: yc-actions/yc-serverless-container-deploy@v1
      with:
        yc-sa-json-credentials: ${{ secrets.YC_SA_KEY_JSON }}
        container-name: risk-reporter-bot
        folder-id: ${{ secrets.YC_FOLDER_ID }}
        image: cr.yandex/crpvrfum4pqm6pp2sv53/risk-reporter-bot:${{ github.sha }}
        memory: 128MB
        cores: 1
        execution-timeout: 30s
        service-account-name: risk-reporter-sa
        environment: |
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          PORT=8080
