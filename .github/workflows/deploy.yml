name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main ]

env:
  REGISTRY_ID: crpvrfum4pqm6pp2sv53
  CONTAINER_NAME: risk-reporter-bot
  SERVICE_ACCOUNT_NAME: risk-reporter-sa

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Yandex Container Registry
      run: |
        echo '${{ secrets.YC_SA_KEY_JSON }}' > sa-key.json
        cat sa-key.json | docker login \
          --username json_key \
          --password-stdin \
          cr.yandex

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          cr.yandex/${{ env.REGISTRY_ID }}/${{ env.CONTAINER_NAME }}:${{ github.sha }}
          cr.yandex/${{ env.REGISTRY_ID }}/${{ env.CONTAINER_NAME }}:latest

    - name: Setup Yandex Cloud CLI
      run: |
        curl https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -a
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

    - name: Configure Yandex Cloud
      run: |
        echo '${{ secrets.YC_SA_KEY_JSON }}' > sa-key.json
        yc config set service-account-key sa-key.json
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

    - name: Deploy to Yandex Cloud Container
      run: |
        yc serverless container revision deploy \
          --container-name ${{ env.CONTAINER_NAME }} \
          --image cr.yandex/${{ env.REGISTRY_ID }}/${{ env.CONTAINER_NAME }}:${{ github.sha }} \
          --cores 1 \
          --memory 128MB \
          --cores-fraction 100 \
          --execution-timeout 30s \
          --concurrency 8 \
          --service-account-name ${{ env.SERVICE_ACCOUNT_NAME }} \
          --environment "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" \
          --environment "PORT=8080"
